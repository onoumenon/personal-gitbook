# SERVERLESS AND APPLICATION SERVICES

## Severless and application services

![](<../../../.gitbook/assets/Screenshot 2021-07-24 at 7.01.18 PM.png>)

internal load balancers

![](<../../../.gitbook/assets/Screenshot 2021-07-24 at 7.05.11 PM.png>)

## Architecture evolution

FIFO

![](<../../../.gitbook/assets/Screenshot 2021-07-24 at 7.08.29 PM.png>)

![](<../../../.gitbook/assets/Screenshot 2021-07-24 at 7.10.33 PM.png>)

gets complex fast when each node has its own queue

![](<../../../.gitbook/assets/Screenshot 2021-07-24 at 7.12.37 PM.png>)

### Event

events can be eg: client uploads a video

best practice: has event router, event bus

![](<../../../.gitbook/assets/Screenshot 2021-07-24 at 7.15.13 PM.png>)

![](<../../../.gitbook/assets/Screenshot 2021-07-24 at 7.16.25 PM.png>)

![](<../../../.gitbook/assets/Screenshot 2021-07-24 at 7.17.48 PM.png>)

## Lambda

![](<../../../.gitbook/assets/Screenshot 2021-07-24 at 7.19.50 PM.png>)

best practice: do one single thing

more memory allocated = more cpu

not persistent

if you want lambda to access public internet resources, you need to config the vpc to support that

![](<../../../.gitbook/assets/Screenshot 2021-07-24 at 7.24.06 PM.png>)

15 minutes execution limit

![](<../../../.gitbook/assets/Screenshot 2021-07-24 at 7.25.54 PM.png>)

## Cloudwatch events (old) and EventBridge (new)

CloudWatch Events and EventBridge have visibility over events generated by supported AWS services within an account.

They can monitor the default account event bus - and pattern match events flowing through and deliver these events to multiple targets.

They are also the source of scheduled events which can perform certain actions at certain times of day, days of the week, or multiple combinations of both - using the Unix CRON time expression format.

Both services are one way how event driven architectures can be implemented within AWS.



Cloudwatch events, 1 bus, can't edit

![](<../../../.gitbook/assets/Screenshot 2021-07-24 at 7.30.00 PM.png>)

event bus is stream of events that services generate

bridge has rules

match -> execute to target

![](<../../../.gitbook/assets/Screenshot 2021-07-24 at 9.01.04 PM.png>)

In this \[DEMO] lesson you will gain experience of using Lambda for some simple account management tasks.

PART1 will deal with simple manual Lambda function invocations

PART2 will give you experience of using an event-driven architecture within AWS using EventBridge

[1-Click Deployment](https://console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/create/review?templateURL=https://learn-cantrill-labs.s3.amazonaws.com/awscoursedemos/0024-aws-associate-lambda-eventdrivenlambda/twoec2instances.yaml\&stackName=TWOEC2)

[lambdarole.json](https://learn-cantrill-labs.s3.amazonaws.com/awscoursedemos/0024-aws-associate-lambda-eventdrivenlambda/lambdarole.json)

[lambda\_instance\_stop.py](https://learn-cantrill-labs.s3.amazonaws.com/awscoursedemos/0024-aws-associate-lambda-eventdrivenlambda/01\_lambda\_instance\_stop.py)

[lambda\_instance\_start.py](https://learn-cantrill-labs.s3.amazonaws.com/awscoursedemos/0024-aws-associate-lambda-eventdrivenlambda/02\_lambda\_instance\_start.py)

[lambda\_instance\_protect.py](https://learn-cantrill-labs.s3.amazonaws.com/awscoursedemos/0024-aws-associate-lambda-eventdrivenlambda/03\_lambda\_instance\_protect.py)

* create stack from link
* lesson is to create lambda functions
* [lambdarole.json](https://learn-cantrill-labs.s3.amazonaws.com/awscoursedemos/0024-aws-associate-lambda-eventdrivenlambda/lambdarole.json) for permissions for lambda
* iam -> role -> create role for aws service lambda (ec2LambdaStartAndStop) -> create policy (paste [lambdarole.json](https://learn-cantrill-labs.s3.amazonaws.com/awscoursedemos/0024-aws-associate-lambda-eventdrivenlambda/lambdarole.json)), create role with policy
* go to ec2 -> copy instances id
* go to lambda -> create from scratch -> (name: ec2stop), python 3.8, change default execution role: choose ec2LambdaStartAndStop, create -> function code, replace skeleton code with  [lambda\_instance\_stop.py](https://learn-cantrill-labs.s3.amazonaws.com/awscoursedemos/0024-aws-associate-lambda-eventdrivenlambda/01\_lambda\_instance\_stop.py)
* scroll down to env var -> edit -> {key: EC2\_INSTANCES, value: {instance id},{instance id}}
* test function via create new test event -> use any event name (no need for params)
* check ec2 instances, it should stop
*   Create lambda for start

    * go to lambda -> create from scratch -> (name: ec2start), python 3.8, change default execution role: choose ec2LambdaStartAndStop, create -> function code, replace skeleton code with [lambda\_instance\_start.py](https://learn-cantrill-labs.s3.amazonaws.com/awscoursedemos/0024-aws-associate-lambda-eventdrivenlambda/02\_lambda\_instance\_start.py)
    * scroll down to env var -> edit -> {key: EC2\_INSTANCES, value: {instance id},{instance id}}
    * test function via create new test event -> use any event name (no need for params)
    * check ec2 instances, it should start


* Create lambda for protect (if instance is stopped, it will trigger lambda to restart instances that are protected)
  * go to lambda -> create from scratch -> (name: ec2protect), python 3.8, change default execution role: choose ec2LambdaStartAndStop, create -> function code, replace skeleton code with [lambda\_instance\_protect.py](https://learn-cantrill-labs.s3.amazonaws.com/awscoursedemos/0024-aws-associate-lambda-eventdrivenlambda/03\_lambda\_instance\_protect.py)
  * event bridge -> create rule -> ec2Protect (start protected instances) -> event pattern -> predefined pattern -> aws service -> ec2 -> ec2 instance state change notification (sample event, state:...) -> specific state: stopped -> copy instance 1 id -> choose specific instance paste id -> choose default event bus -> target (ec2Protect)
  * stop instance 1 should restart it
* cloudwatch -> log group (ec2 protect), lambda prints an event log when invoked
* schedule rule -> lambda -> schedule, cron expression: {minute} {hour} {day of month} {month} {day of week} {year} in utc timezone



